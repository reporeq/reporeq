#!/usr/bin/env bash
# Tests for reporeq

set -euo pipefail

cd "$(dirname "$0")"

# shellcheck source=./reporeq
source "./reporeq"

PASS=0 FAIL=0

pass() { echo "✓ $*"; PASS=$((PASS + 1)); }
fail() { echo "✗ $*"; FAIL=$((FAIL + 1)); }

test_parse() {
    local input="$1" expected_url="$2" expected_ref="$3"
    parse_line "$input"
    if [[ "$PARSE_URL" == "$expected_url" && "$PARSE_REF" == "$expected_ref" ]]; then
        pass "$input"
    else
        fail "$input"
        echo "  expected: url='$expected_url' ref='$expected_ref'"
        echo "  got:      url='$PARSE_URL' ref='$PARSE_REF'"
    fi
}

cleanup_test() { rm -rf .reporeq test.txt; }

echo "=== Unit tests: parse_line ==="
echo

# HTTPS URLs
test_parse "https://github.com/user/repo" "https://github.com/user/repo" ""
test_parse "https://github.com/user/repo@v1.0.0" "https://github.com/user/repo" "v1.0.0"
test_parse "https://github.com/user/repo@abc123def" "https://github.com/user/repo" "abc123def"
test_parse "https://github.com/user/repo@feature/branch" "https://github.com/user/repo" "feature/branch"
test_parse "https://github.com/user/repo@feature/sub/branch" "https://github.com/user/repo" "feature/sub/branch"
test_parse "https://github.com/user/repo.git@main" "https://github.com/user/repo.git" "main"

# SSH URLs
test_parse "git@github.com:user/repo.git" "git@github.com:user/repo.git" ""
test_parse "git@github.com:user/repo.git@v2.0.0" "git@github.com:user/repo.git" "v2.0.0"
test_parse "git@gitlab.com:org/repo.git@develop/feature" "git@gitlab.com:org/repo.git" "develop/feature"

# URLs with basic auth
test_parse "https://user:pass@github.com/org/repo" "https://user:pass@github.com/org/repo" ""
test_parse "https://user:pass@github.com/org/repo@v1.0.0" "https://user:pass@github.com/org/repo" "v1.0.0"
test_parse "https://token:x-oauth@github.com/org/repo@feature/branch" "https://token:x-oauth@github.com/org/repo" "feature/branch"
test_parse "https://token@github.com/org/repo@main" "https://token@github.com/org/repo" "main"

echo
echo "=== Integration tests ==="
echo

# Test basic clone
cleanup_test
echo "https://github.com/reporeq/reporeq" > test.txt
./reporeq test.txt
if [[ -d ".reporeq/reporeq" ]]; then
    pass "Basic clone works"
else
    fail "Basic clone failed"
fi
cleanup_test

# Test SHA checkout
echo "https://github.com/reporeq/reporeq@35316e9e99c4de8ccbda37950766a4aa707932f2" > test.txt
./reporeq test.txt
actual_sha=$(git -C .reporeq/reporeq rev-parse HEAD)
expected="35316e9e99c4de8ccbda37950766a4aa707932f2"
if [[ "$actual_sha" == "$expected" ]]; then
    pass "SHA checkout works: $actual_sha"
else
    fail "SHA mismatch: expected $expected, got $actual_sha"
fi
cleanup_test

# Test comments and empty lines
cat > test.txt << 'EOF'
# This is a comment

https://github.com/reporeq/reporeq
# Another comment

EOF
./reporeq test.txt
if [[ -d ".reporeq/reporeq" ]]; then
    pass "Comments/empty lines handled correctly"
else
    fail "Comments/empty lines not handled"
fi
cleanup_test

# Test overlay feature
cat > test.txt << 'EOF'
https://github.com/reporeq/reporeq@35316e9e99c4de8ccbda37950766a4aa707932f2
https://github.com/reporeq/reporeq
EOF
./reporeq test.txt
actual_sha=$(git -C .reporeq/reporeq rev-parse HEAD)
first_sha="35316e9e99c4de8ccbda37950766a4aa707932f2"
if [[ "$actual_sha" != "$first_sha" ]]; then
    pass "Overlay works: later entry overwrote earlier"
else
    fail "Overlay failed: should have HEAD, got first SHA"
fi
cleanup_test

# Test failure on invalid URL
echo "https://github.com/this-repo-does-not-exist-12345/invalid" > test.txt
if ./reporeq test.txt 2>/dev/null; then
    fail "Should have failed on invalid URL"
elif [[ -d ".reporeq" ]]; then
    fail ".reporeq should not exist after failure"
else
    pass "Invalid URL correctly fails without leaving partial state"
fi
rm -f test.txt

# Test bin symlinks
./reporeq ../example.txt
if [[ -d ".reporeq/bin" ]]; then
    if [[ -L ".reporeq/bin/reporeq" ]] || [[ -f ".reporeq/bin/reporeq" ]]; then
        pass "Bin symlinks created correctly"
    else
        fail "reporeq symlink not found in .reporeq/bin/"
    fi
else
    fail ".reporeq/bin/ directory not found"
fi
cleanup_test

echo
echo "=== Results: $PASS passed, $FAIL failed ==="
[[ $FAIL -eq 0 ]]
