name: Test reporeq

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    defaults:
      run:
        shell: bash
        working-directory: bin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test basic clone
        run: |
          echo "https://github.com/reporeq/reporeq" > test.txt
          ./reporeq test.txt
          [[ -d ".reporeq/reporeq" ]] && echo "✓ Basic clone works"
          rm -rf .reporeq test.txt

      - name: Test SHA checkout
        run: |
          echo "https://github.com/reporeq/reporeq@35316e9e99c4de8ccbda37950766a4aa707932f2" > test.txt
          ./reporeq test.txt

          actual_sha=$(git -C .reporeq/reporeq rev-parse HEAD)
          expected="35316e9e99c4de8ccbda37950766a4aa707932f2"
          if [[ "$actual_sha" == "$expected" ]]; then
            echo "✓ SHA checkout works: $actual_sha"
          else
            echo "✗ SHA mismatch: expected $expected, got $actual_sha"
            exit 1
          fi

          rm -rf .reporeq test.txt

      - name: Test comments and empty lines
        run: |
          cat > test.txt << 'EOF'
          # This is a comment

          https://github.com/reporeq/reporeq
          # Another comment

          EOF
          ./reporeq test.txt
          [[ -d ".reporeq/reporeq" ]] && echo "✓ Comments/empty lines handled correctly"
          rm -rf .reporeq test.txt

      - name: Test overlay feature
        run: |
          cat > test.txt << 'EOF'
          https://github.com/reporeq/reporeq@35316e9e99c4de8ccbda37950766a4aa707932f2
          https://github.com/reporeq/reporeq
          EOF
          ./reporeq test.txt
          actual_sha=$(git -C .reporeq/reporeq rev-parse HEAD)
          first_sha="35316e9e99c4de8ccbda37950766a4aa707932f2"
          if [[ "$actual_sha" != "$first_sha" ]]; then
            echo "✓ Overlay works: later entry overwrote earlier"
          else
            echo "✗ Overlay failed: should have HEAD, got first SHA"
            exit 1
          fi

          rm -rf .reporeq test.txt

      - name: Test failure on invalid URL
        run: |
          rm -rf .reporeq
          echo "https://github.com/this-repo-does-not-exist-12345/invalid" > test.txt
          if ./reporeq test.txt 2>/dev/null; then
            echo "✗ Should have failed on invalid URL"
            exit 1
          fi

          if [[ -d ".reporeq" ]]; then
            echo "✗ .reporeq should not exist after failure"
            exit 1
          fi
          echo "✓ Invalid URL correctly fails without leaving partial state"
          rm -f test.txt

      - name: Test bin symlinks
        run: |
          ./reporeq ../example.txt
          if [[ -d ".reporeq/bin" ]]; then
            echo "✓ .reporeq/bin/ directory created"
            ls -la .reporeq/bin/
            if [[ -L ".reporeq/bin/reporeq" ]] || [[ -f ".reporeq/bin/reporeq" ]]; then
              echo "✓ reporeq symlink exists"
            fi
          else
            echo "✗ .reporeq/bin/ directory not found"
            exit 1
          fi

